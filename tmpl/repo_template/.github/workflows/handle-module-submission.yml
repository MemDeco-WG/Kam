name: Handle Module Submission

on:
  issues:
    types: [opened]

jobs:
  process-submission:
    if: contains(github.event.issue.labels.*.name, 'module-submission')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Parse and validate module metadata
      id: parse
      uses: actions/github-script@v7
      with:
        script: |
          const body = context.payload.issue.body;

          // Expected format: JSON object with module metadata
          let metadata;
          try {
            metadata = JSON.parse(body);
          } catch (e) {
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ Invalid JSON format. Please provide valid module metadata JSON.'
            });
            return;
          }

          // Validate required fields
          const required = ['id', 'name', 'version', 'versionCode', 'author', 'description'];
          const missing = required.filter(field => !metadata[field]);

          if (missing.length > 0) {
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `❌ Missing required fields: ${missing.join(', ')}`
            });
            return;
          }

          // Set outputs for next steps
          core.setOutput('metadata', JSON.stringify(metadata));
          core.setOutput('valid', 'true');

    - name: Update modules.json
      if: steps.parse.outputs.valid == 'true'
      run: |
        METADATA='${{ steps.parse.outputs.metadata }}'
        jq --argjson meta "$METADATA" '.modules += [$meta]' json/modules.json > json/modules_temp.json
        mv json/modules_temp.json json/modules.json

    - name: Generate index
      if: steps.parse.outputs.valid == 'true'
      run: |
        ./generate_index.sh

    - name: Create pull request
      if: steps.parse.outputs.valid == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "Add module: ${{ fromJson(steps.parse.outputs.metadata).id }}"
        title: "Add module: ${{ fromJson(steps.parse.outputs.metadata).name }}"
        body: |
          This PR adds a new module submitted via issue #${{ github.event.issue.number }}

          **Module Details:**
          - ID: ${{ fromJson(steps.parse.outputs.metadata).id }}
          - Name: ${{ fromJson(steps.parse.outputs.metadata).name }}
          - Version: ${{ fromJson(steps.parse.outputs.metadata).version }}
          - Author: ${{ fromJson(steps.parse.outputs.metadata).author }}

          **Description:**
          ${{ fromJson(steps.parse.outputs.metadata).description }}

          ---
          Auto-generated by module submission workflow
        branch: add-module-${{ fromJson(steps.parse.outputs.metadata).id }}
        delete-branch: true

    - name: Comment on issue
      if: steps.parse.outputs.valid == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '✅ Module submission processed! A pull request has been created for review.'
          });

          github.rest.issues.update({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'closed'
          });
